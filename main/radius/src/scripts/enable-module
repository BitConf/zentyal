#!/bin/bash -x

# generate certificates
if test ! -e /etc/freeradius/certs/freeradius.pem
then
    if test ! -e /etc/ssl/certs/ssl-cert-snakeoil.pem || \
       test ! -e /etc/ssl/private/ssl-cert-snakeoil.key
    then
        make-ssl-cert generate-default-snakeoil
    fi

    cat /etc/ssl/certs/ssl-cert-snakeoil.pem \
        /etc/ssl/private/ssl-cert-snakeoil.key \
        > /etc/freeradius/certs/freeradius.pem

    chown root:freerad /etc/freeradius/certs/freeradius.pem
    chmod 440 /etc/freeradius/certs/freeradius.pem
else
    chown root:freerad /etc/freeradius/certs/freeradius.pem
    chmod 440 /etc/freeradius/certs/freeradius.pem
fi

# freeradius log permission
chmod 755 /var/log/freeradius

# add freerad to winbindd_priv group
usermod -a -G winbindd_priv freerad

# fix winbindd_privileged ownership
chown root:winbindd_priv /var/lib/samba/winbindd_privileged
